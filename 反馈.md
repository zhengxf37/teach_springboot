# 代码问题

注意：上传文件功能分开，查询用户信息需要1查询文字信息（用户名，邮箱等）2查询他的文件路径，然后依次访问（可能下载）文件

注意：上传视频感觉占用高且效果差，暂时限制上传一张图片，一个pdf文档，放在`/teach_springboot/upload_data`下



# JWT策略

1. 什么是JWT？

* JWT全称JSON Web Token，其中**Token** 是计算机领域中的一种**数字凭证**，用于安全地验证用户身份或授权访问资源。

2. JWT包括什么？

* 下面是一个典型的JWT，按照`.`分隔

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0IiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

* **Header**：算法和类型（如HS256 + JWT）
* **Payload**：用户数据（如用户ID、过期时间[eg.86400s]）
* **Signature**：用密钥对前两部分签名，防篡改。

* 因此，当服务端拿到前端传来的JWT时，可以先从解析Header和Payload的数据，然后使用服务端配置的密钥对这两部分签名得到服务端签名，拿这个签名和Token的签名进行比对来验证Token有效性。

3. 实现流程：

* 在代码中的注册登录模块里最后会生成一个Token并返回，接下来当用户进入平台后发送的API请求一般都带有Token，首先我在`Spring MVC`中注册了拦截器`JwtInterceptor`，拦截器会对除注册登录以外的所有API进行预处理，包括：

  * 验证令牌有效性，如果无效则抛出异常，否则进入下一步

  * 存储用户信息到当前http请求request中，把请求转发到controller层以便controller层可以直接使用

```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
		// ......
        // 存储用户信息到当前http请求request中，以便controller层可以直接使用
        request.setAttribute("username", username);
        request.setAttribute("userId", jwtUtil.extractClaim(token, claims -> claims.get("userId", Long.class)));
        request.setAttribute("userType", jwtUtil.extractClaim(token, claims -> claims.get("userType", String.class)));

        return true;
    }
```

* 接下来在controller层就可以使用转发来的request获取信息，如用户ID。获取属性的代码如下：

```java
public ResponseEntity<UserInfoVO> updateUserInfo(
            HttpServletRequest request,
            @RequestBody UserInfoUpdateDTO userInfoUpdateDTO) {
        // 从token中获取用户ID
        Long userId = (Long) request.getAttribute("userId");
```

![](assets/Token策略.png)